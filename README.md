# manydeps-cln

[![CMake on Multiple Platforms](https://github.com/manydeps/manydeps-cln/actions/workflows/cmake-multi-platform.yml/badge.svg)](https://github.com/manydeps/manydeps-cln/actions/workflows/cmake-multi-platform.yml)

[![Bazel on multiple platforms](https://github.com/manydeps/manydeps-cln/actions/workflows/bazel-multi-platform.yml/badge.svg)](https://github.com/manydeps/manydeps-cln/actions/workflows/bazel-multi-platform.yml)

![C++17](https://img.shields.io/badge/std-c%2B%2B17-blue) [![C++20_/permissive](https://img.shields.io/badge/std-c%2B%2B20_%2Fpermissive-blue)](https://devblogs.microsoft.com/cppblog/msvc-cpp20-and-the-std-cpp20-switch/)

***Beware that c++20 only works with /permissive flag on windows, otherwise we get link errors LNK2019***.

This is a demonstration project from the [ManyDeps](https://github.com/manydeps),
for the C/C++ [CLN library from GINAC](https://www.ginac.de/CLN/) with GMP library using package managers (vcpkg and conan) on windows/linux.

This works fine on Windows Visual Studio 2022 and also Linux (including Windows WSL).
For Linux, the classic `gmp` library is used, but for Windows, the alternative `mpir`
is used (since `gmp` currently fails to build on Windows in this repo).

Basic setup in both platforms include: CMake and Ninja.
Also it is necessary to have vcpkg and conan, for the following scripts to work.

## Running the example on vcpkg

Please follow the next steps carefully.

### First step: get submodule dependencies

vcpkg is installed as shown in [vcpkg.io](vcpkg.io website), as a git submodule.

To get submodules, please run the following commands:

```
git submodule update --init --recursive
git pull --recurse-submodules
```

Check the folder [tools/vcpkg](tools/vcpkg) to see if vcpkg is present.

### Second step: get vcpkg dependencies

Automatically done on Visual Studio 2022! 

## Windows working example

Using system vcpkg:

```
PS C:\Users\XXXX\Source\Repos\manydeps-cln> vcpkg --version
vers√£o do programa de gerenciamento de pacotes vcpkg 2023-06-22-f19f3d9939100085fe2f7e41502d60b08e2083b6
```

Using local vcpkg (from submodule):

```
vcpkg package management program version 2023-08-09-9990a4c9026811a312cb2af78bf77f3d9d288416
```

## Linux working example

Using system vcpkg (from devcontainer image):

```
$ vcpkg --version
vcpkg package management program version 2023-01-24-8a88d63f241d391772fbde69af9cab96c3c64c75
```

Using local vcpkg (from submodule):

```
vcpkg package management program version 2023-08-09-9990a4c9026811a312cb2af78bf77f3d9d288416
```

<!--

#### On Windows

On Windows Visual Studio, open the **Developer Command Prompt** and execute:

```
.\tools\vcpkg\bootstrap-vcpkg.bat
.\script-deps.bat
```

#### On Linux (or WSL)

On Linux (or WSL), just run:

```
./tools/vcpkg/bootstrap-vcpkg.sh 
./script-deps.sh
```

-->

## Common errors

On Linux, sometimes dependencies are not fully available, so please double check:

### Latest CMake on Linux

```
python3 -m pip install --upgrade
```

### Ninja on Linux

```
apt-get install ninja-build
```

### General build dependencies on Linux

vcpkg requires some packages, such as pkg-config and autoconf:

```
apt-get install autoconf automake libtool pkg-config
```

## Using CMakePresets for IDE

Update your CMakePresets.json to include the desired toolchain.

### vcpkg toolchain

```{.json}
"toolchainFile": "${sourceDir}/deps/vcpkg/scripts/buildsystems/vcpkg.cmake",
```

Read more on vcpkg integration: https://learn.microsoft.com/pt-br/vcpkg/users/buildsystems/cmake-integration

### conan toolchain

Install conan with:

```
python3 -m pip install conan
```

Setup toolchain with cmake and conan:

```{.json}
"cacheVariables": {
    "CMAKE_BUILD_TYPE": "Release",
    "CMAKE_TOOLCHAIN_FILE": "build-conan/conan_toolchain.cmake"
},
```

## Discussion and common errors

The vcpkg tries to create some CMake toolchain with PkgConfig, 
in order to get dependencies.
We try to build them as **STATIC** libraries: 
`libgmp.a` (on linux) and `gmp.lib` (on windows).

This is the expected configuration after `vcpkg install`:

```
[cmake]     #  gmp
[cmake]     find_package(PkgConfig REQUIRED)
[cmake]     pkg_check_modules(gmp REQUIRED IMPORTED_TARGET gmp)
[cmake]     target_link_libraries(main PkgConfig::gmp)
[cmake] 
[cmake]     # gmpxx
[cmake]     find_package(PkgConfig REQUIRED)
[cmake]     pkg_check_modules(gmpxx REQUIRED IMPORTED_TARGET gmpxx)
[cmake]     target_link_libraries(main PkgConfig::gmpxx)
```

However, this failed in both Linux and Windows (in our experiments here),
 so we need to make some adjustments (**A LOT OF ADJUSTMENTS FOR WINDOWS**).

### Trying to understand the errors

The idea is to load packages locally on `build/vcpkg_installed/` folder 
(generated by vcpkg on our `script-deps`).

We still could not fully understand why it fails so bad in Windows,
but it seems that some files such as `gmp.pc` are missing!
For Linux they exist on `build/vcpkg_installed/x64-linux/lib/pkgconfig/` folder.

If you find a better solution, please Let Us Know!


## Using Bazel

Bazel is **so much simpler!**
Please take a look at [cln.BUILD](cln.BUILD) and [gmp.BUILD](gmp.BUILD),
that declare both external libraries GMP and CLN.

```
bazel build ... --config windows
bazel test ... --config windows
bazel run @cln//:cln_example_fibonacci 10
```

## Known Issues

### Regarding CMake
For CLN, the cmake build cannot be made using "-B build", 
since it only works changing directory to build folder (pattern "cd build && cmake ..").
The failure happens with "AsmUnderscode.cmake" test, and some attempts to solve this issue
have currently failed.

### Regarding MSVC

The [Microsoft Visual C++](https://en.wikipedia.org/wiki/Microsoft_Visual_C%2B%2B) has been tested in two versions (image `windows-latest`):
- It works on version for CMake: C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Tools\MSVC\14.35.32215\bin\HostX64\x64\cl.exe
- It works on version for Bazel: C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Tools\MSVC\14.37.32822\bin\HostX64\x64\cl.exe

Remember that `long` is 32 bits on windows and 64 bits on linux.
All these flags are passed on `.bazelrc` or CMake.

### Issues with C++ standard

On Windows, when using c++20 the code refuses to link (maybe due to some previously non-c++20 dependency):

```
[5 / 6] Linking app_demo_cln.exe; 1s local
ERROR: D:/a/manydeps-cln/manydeps-cln/BUILD.bazel:21:10: Linking app_demo_cln.exe failed: (Exit 1120): link.exe failed: error executing command (from target //:app_demo_cln) C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Tools\MSVC\14.35.32215\bin\HostX64\x64\link.exe @bazel-out/x64_windows-fastbuild/bin/app_demo_cln.exe-2.params
cln.lib(cl_prin_globals.obj) : error LNK2019: unresolved external symbol "struct cln::cl_heap_string * __cdecl cl_make_heap_string(char const *)" (?cl_make_heap_string@@YAPEAUcl_heap_string@cln@@PEBD@Z) referenced in function "public: __cdecl cln::cl_string::cl_string(char const *)" (??0cl_string@cln@@QEAA@PEBD@Z)
  Hint on symbols that are defined and could potentially match:
    "struct cln::cl_heap_string * __cdecl cln::cl_make_heap_string(char const *)" (?cl_make_heap_string@cln@@YAPEAUcl_heap_string@1@PEBD@Z)
bazel-out\x64_windows-fastbuild\bin\app_demo_cln.exe : fatal error LNK1120: 1 unresolved externals
Target //:app_demo_cln failed to build
```

This error does not happen with c++17 on windows or linux.
With linux c++20 it works fine.
On windows, it works with `c++20 /permissive` (but not with `/permissive-`).

It seems that this is due to some breaking ABI change and name mangling differences: see [Microsoft Blog Post on C++20](https://devblogs.microsoft.com/cppblog/msvc-cpp20-and-the-std-cpp20-switch/).

### Issues with Bazel and CL toolchain

The GitHub folder contains several VC instances:

```
dir "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Tools\MSVC"
.
..
14.16.27023
14.29.30133
14.35.32215
14.37.32822
```

On `windows-2022` image, the official cl is `14.35.32215`, but bazel chooses toolchain `14.37.32822`.
Could not find any solution to fix this! Not even deleting the folder (as it breaks) and using BAZEL_VC + FULL flags.

## License

MIT License + LGPL License if using gmp or mpir
